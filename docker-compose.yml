version: "3.9"

services:

  # creates privileged container
  autoheal:
    container_name: autoheal
    image: willfarrell/autoheal:1.2.0
    restart: always
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:Z
      
  pushgateway_01:
    image: prom/pushgateway
    restart: always
    networks:
      db1000n-network:
        ipv4_address: 172.20.0.97
    ports:
      - "9097:9091"

  pushgateway_02:
    image: prom/pushgateway
    restart: always
    networks:
      db1000n-network:
        ipv4_address: 172.20.0.98
    ports:
      - "9098:9091"

  pushgateway_03:
    image: prom/pushgateway
    restart: always
    networks:
      db1000n-network:
        ipv4_address: 172.20.0.99
    ports:
      - "9099:9091"

  prometheus:
    image: prom/prometheus
    restart: always
    hostname: prometheus
    networks:
      - db1000n-network
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus
    command: --config.file=/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana
    restart: always
    hostname: grafana
    networks:
      - db1000n-network
    ports:
      - "3000:3000"
    volumes:
      - ./grafana-storage:/var/lib/grafana

  # creates OpenVPN Docker container to first provider that randomly picks .conf file
  ovpn_01:
    image: ghcr.io/wfg/openvpn-client:2.1.0
    cap_add:
      - NET_ADMIN
    security_opt:
      - label:disable
    restart: unless-stopped
    volumes:
      - /dev/net:/dev/net:z
      - ./openvpn/:/data/vpn:z
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      KILL_SWITCH: "on"
      HTTP_PROXY: "off"
      VPN_AUTH_SECRET: provider01_secret
      VPN_CONFIG_PATTERN: provider01*.conf # this will match provider01_country01.conf, provider01_country02.conf etc
    secrets:
      - provider01_secret
    labels:
        autoheal: "true"
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3
    networks:
      - db1000n-network

  # creates OpenVPN Docker container to first provider with specific .conf file
  ovpn_02:
    image: ghcr.io/wfg/openvpn-client:2.1.0
    cap_add:
      - NET_ADMIN
    security_opt:
      - label:disable
    restart: unless-stopped
    volumes:
      - /dev/net:/dev/net:z
      - ./openvpn/:/data/vpn:z
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      KILL_SWITCH: "on"
      HTTP_PROXY: "off"
      VPN_AUTH_SECRET: provider01_secret
      VPN_CONFIG_FILE: provider01.endpoint02.conf # will use only this .conf file
    secrets:
      - provider01_secret
    labels:
        autoheal: "true"
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3
    networks:
      - db1000n-network

  # creates OpenVPN Docker container to second provider with specific .conf file
  ovpn_03:
    image: ghcr.io/wfg/openvpn-client:2.1.0
    cap_add:
      - NET_ADMIN
    security_opt:
      - label:disable
    restart: unless-stopped
    volumes:
      - /dev/net:/dev/net:z
      - ./openvpn/:/data/vpn:z
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      KILL_SWITCH: "on"
      HTTP_PROXY: "off"
      VPN_AUTH_SECRET: provider02_secret
      VPN_CONFIG_FILE: provider02.endpoint01.conf # will use only this .conf file
    secrets:
      - provider02_secret
    labels:
        autoheal: "true"
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3
    networks:
      - db1000n-network

  # [OPTIONAL]
  # run db1000n in updater mode, which will fetch configuration bypassing VPN and store it in shared volume
  updater:
    image: ghcr.io/arriven/db1000n
    restart: unless-stopped
    labels:
      autoheal: "true"
    entrypoint: "./db1000n --updater-mode"
    volumes:
      - ./config:/usr/src/app/config:z
    environment:
      UPDATER_DESTINATION_CONFIG: "config/config.json"
    healthcheck:
      test: [ "CMD", "test", "-f", "config/config.json" ]
      timeout: 5s
      interval: 5s
      retries: 5
   networks:
      - db1000n-network 

  # this Docker container will use VPN 01
  # it will use config.json created by 'updater' container above
  # this is set by specifying same volume and -c config/config.json
  db1000n_01:
    image: ghcr.io/arriven/db1000n-advanced
    restart: unless-stopped
    depends_on:
      ovpn_01:
        condition: service_healthy
      updater:
        condition: service_healthy
    network_mode: "service:ovpn_01"
    labels:
        autoheal: "true"
    # set single country to check IP against and exit container if IP matches country OR IP cannot be determined
    environment:
      STRICT_COUNTRY_CHECK: "true"
      COUNTRY_LIST: "Country"
      CONFIG: "config/config.json"
      PROMETHEUS_ON: "true"
      PROMETHEUS_GATEWAYS: "http://172.20.0.97:9091"
    volumes:
      - ./config:/usr/src/app/config:z
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3

  # this Docker container will use VPN 02
  # it will use config.json created by 'updater' container above
  # this is set by specifying same volume and -c config/config.json
  db1000n_02:
    image: ghcr.io/arriven/db1000n-advanced
    restart: unless-stopped
    depends_on:
      ovpn_02:
        condition: service_healthy
      updater:
        condition: service_healthy
    network_mode: "service:ovpn_02"
    labels:
        autoheal: "true"
    # set multiple countries to check IP against and exit container if IP matches country OR IP cannot be determined
    environment:
      STRICT_COUNTRY_CHECK: "true"
      COUNTRY_LIST: "Country, Another Country"
      CONFIG: "config/config.json"
      PROMETHEUS_ON: "true"
      PROMETHEUS_GATEWAYS: "http://172.20.0.98:9091"
    volumes:
      - ./config:/usr/src/app/config:z
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3

  # this Docker container will use VPN 03
  # it will download config itself and won't access shared volume so those options are undefined here
  db1000n_03:
    image: ghcr.io/arriven/db1000n-advanced
    restart: unless-stopped
    depends_on:
      ovpn_03:
        condition: service_healthy
    network_mode: "service:ovpn_03"
    labels:
        autoheal: "true"
    # set single country to check IP against but do not exit container if IP matches country
    environment:
      STRICT_COUNTRY_CHECK: "false"
      COUNTRY_LIST: "Country"
      PROMETHEUS_ON: "true"
      PROMETHEUS_GATEWAYS: "http://172.20.0.99:9091"
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3

networks:
  db1000n-network:
    ipam:
      config:
        - subnet: 172.20.0.0/16

secrets:
  provider01_secret:
    file: ./openvpn/provider01.txt
  provider02_secret:
    file: ./openvpn/provider02.txt