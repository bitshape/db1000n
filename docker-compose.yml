version: "3.9"

services:

  pgone:
    image: prom/pushgateway
    restart: always
    networks:
      db1000n-network:
        ipv4_address: 172.20.0.97
    ports:
      - "9098:9091"

  pgtwo:
    image: prom/pushgateway
    restart: always
    networks:
      db1000n-network:
        ipv4_address: 172.20.0.98
    ports:
      - "9099:9091"
  
  prometheus:
    image: prom/prometheus
    restart: always
    hostname: prometheus
    networks:
      - db1000n-network
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus
    command: --config.file=/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana
    restart: always
    hostname: grafana
    networks:
      - db1000n-network
    ports:
      - "3000:3000"
    volumes:
      - ./grafana-storage:/var/lib/grafana

  autoheal:
    image: ghcr.io/bitshape/autoheal:latest
    restart: always
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:Z
    networks:
      - db1000n-network

  ovpn_surfshark_01:
    image: ghcr.io/bitshape/openvpn-client:2.1.0
    cap_add:
      - NET_ADMIN
    security_opt:
      - label:disable
    restart: always
    hostname: vpn_01
    volumes:
      - /dev/net:/dev/net:z
      - ./openvpn/:/data/vpn:z
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    labels:
      autoheal: "true"
    environment:
      KILL_SWITCH: "on"
      HTTP_PROXY: "off"
      VPN_AUTH_SECRET: surfshark_secret
      VPN_CONFIG_PATTERN: "*.surfshark.com_udp.ovpn"
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3
    networks:
      - db1000n-network
    secrets:
      - surfshark_secret
  
  ovpn_surfshark_02:
    image: ghcr.io/bitshape/openvpn-client:2.1.0
    cap_add:
      - NET_ADMIN
    security_opt:
      - label:disable
    restart: always
    hostname: vpn_02
    volumes:
      - /dev/net:/dev/net:z
      - ./openvpn/:/data/vpn:z
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    labels:
      autoheal: "true"
    environment:
      KILL_SWITCH: "on"
      HTTP_PROXY: "off"
      VPN_AUTH_SECRET: surfshark_secret
      VPN_CONFIG_PATTERN: "*.surfshark.com_udp.ovpn"
    healthcheck:
      test: [ "CMD", "nslookup", "google.com", "8.8.8.8" ]
      timeout: 10s
      interval: 30s
      retries: 3
    networks:
      - db1000n-network
    secrets:
      - surfshark_secret

  db1000n_01:
    image: db1000n
    restart: unless-stopped
    environment:
      PROMETHEUS_ON: "true"
      PROMETHEUS_GATEWAYS: "http://172.20.0.97:9091"
      CONFIG: "https://raw.githubusercontent.com/db1000n-coordinators/LoadTestConfig/main/config.v0.7.adv.json"
    depends_on:
      - ovpn_surfshark_01
    network_mode: "service:ovpn_surfshark_01"
  
  db1000n_02:
    image: db1000n
    restart: unless-stopped
    environment:
      PROMETHEUS_ON: "true"
      PROMETHEUS_GATEWAYS: "http://172.20.0.98:9091"
      CONFIG: "https://raw.githubusercontent.com/db1000n-coordinators/LoadTestConfig/main/config.v0.7.adv.json"
    depends_on:
      - ovpn_surfshark_02
    network_mode: "service:ovpn_surfshark_02"

networks:
  db1000n-network:
    ipam:
      config:
        - subnet: 172.20.0.0/16

secrets:
  surfshark_secret:
    file: ./openvpn/surfshark.txt
